<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"></script>
    <!-- Require the peer dependencies of pose-detection. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>

    <!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.125/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scatter-gl@0.0.11/lib/scatter-gl.min.js"></script>
  </head>
  <body>
    <h1>3D Polygon Normalization</h1>

    <h2>Concept Training</h2>
    <div>
      <div class="grouping">
        <div id="rotateContainer" class="chart"></div>
      </div>
      <div class="stepControls">
        <div class="creators">
          <p>Create</p>
          <button id="similarTriangles">Similar Triangles</button>
          <button id="randomTriangles">Random Triangles</button>
          <button id="exactPolies">Exact Poly Shapes</button>
        </div>
        <div>
          <button id="originGoalPoly">Move Goal to Origin</button>
          <button id="originInputPoly">Move Input to Origin</button>
          <button id="alignGoalPoly">Align Goal Secondary</button>
          <button id="alignInputPoly">Align Input Secondary</button>
          <button id="rotateToGoal">Rotate Input to Goal</button>
        </div>
      </div>
    </div>
    <div class="funland">
      <p>Mod</p>
      <button id="rotateX">Rotate X</button>
      <button id="rotateY">Rotate Y</button>
      <button id="rotateZ">Rotate Z</button>
      <button id="spinEm">Spin 3D</button>
    </div>
    <hr />
    <h2>Pose Application</h2>
    <div class="stepControls">
      <div>
        <span id="poseText"
          >Pose Points
          <img src="blaze_points.png" alt="blaze_points" id="poseImg" />
        </span>
        <span>
          <label for="focalPoint">Focal Point</label>
          <select id="focalPoint" name="focalPoint" class="focal">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11" selected>11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
          </select>
        </span>
        <span>
          <label for="Align Point">Align Point</label>
          <select id="alignPoint" name="Align Point" class="align">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12" selected>12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
          </select>
        </span>
        <span>
          <label for="Rotation Point">Rotation Point</label>
          <select id="rotatePoint" name="Rotation Point" class="rotate">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22">22</option>
            <option value="23" selected>23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
          </select>
        </span>
        <button id="loadPoses">Load 3D Poses</button>
      </div>
    </div>
    <div id="squeezer">
      <div class="poseGroup">
        <div class="grouping">
          <h2>Input</h2>
          <div id="inputContainer" class="chart"></div>
        </div>
        <div class="grouping">
          <h2>Goal</h2>
          <div id="goalContainer" class="chart"></div>
        </div>
        <div class="grouping">
          <h2>Transformed</h2>
          <div id="transformedContainer" class="chart"></div>
        </div>
      </div>
    </div>
    <div class="stepControls">
      <button id="runProcess">Run Normalization Process</button>
    </div>

    <script type="module">
      import {
        BLAZEPOSE_CONNECTED_KEYPOINTS_PAIRS,
        POSES,
        ANCHOR_POINTS,
      } from './constants.js'
      import {
        selectColor,
        simpleTriangle,
        generateMeta,
        create3DPolygon,
        drawMulti,
      } from './helpers.js'

      // OPTIMIZATION NOTE:  The following code is a demonstration, where all points are rotated through 3D space.
      // You could simply rotate and align the 3 points used and then create a custom transform matrix along the way.
      // That derived matrix could batch-apply to all remaining points in one cross product transform.

      function spinEm() {
        window.inputContainer.startOrbitAnimation &&
          window.inputContainer.startOrbitAnimation()
        window.goalContainer.startOrbitAnimation &&
          window.goalContainer.startOrbitAnimation()
        window.transformedContainer.startOrbitAnimation &&
          window.transformedContainer.startOrbitAnimation()
        window.rotateContainer.startOrbitAnimation &&
          window.rotateContainer.startOrbitAnimation()
      }

      function createStandard() {
        const random = simpleTriangle([1, 1, 0.2])
        const triangle = simpleTriangle()
        drawMulti('rotateContainer', [random, triangle])
        // store R in global for debug accessibility
        window.R = [random, triangle]
      }

      function createR() {
        const random = create3DPolygon(3)
        const triangle = create3DPolygon(3)

        drawMulti('rotateContainer', [random, triangle])
        // store R in global for debug accessibility
        window.R = [random, triangle]
      }

      function createT(pointCount = 6) {
        let random = create3DPolygon(pointCount)

        const lock = {
          polyPoints: [...random.polyPoints],
          metadata: [...random.metadata],
          sequences: [...random.sequences],
        }
        window.R = [random, lock]
        rotate('x', 0, Math.random())
        rotate('y', 0, Math.random())
        rotate('z', 0, Math.random())
      }

      function originPoly(polyIndex = 0) {
        const R = window.R
        const polygon = R[polyIndex]
        const focalPoint = polygon.polyPoints[0]
        // This is a non-vector translation to origin
        polygon.polyPoints.map((point, idx) => {
          polygon.polyPoints[idx] = point.map((v, i) => v - focalPoint[i])
        })
        // A vector translation to origin would be
        // https://bit.ly/3DQbNbZ
        R[polyIndex] = polygon
        drawMulti('rotateContainer', R)
        window.R = R
      }

      function alignPoly(polyIndex = 0) {
        const R = window.R
        let polygon = R[polyIndex]
        let alignPoint = polygon.polyPoints[1]

        const xang = Math.atan2(alignPoint[1], alignPoint[0])
        polygon = rotate('z', polyIndex, xang)

        alignPoint = polygon.polyPoints[1]
        const zang = Math.atan2(alignPoint[2], alignPoint[0])
        rotate('y', polyIndex, zang)
      }

      function rotateToGoal() {
        const R = window.R
        const rotatePoint = R[0].polyPoints[2]
        const goalRotatePoint = R[1].polyPoints[2]

        const myang = Math.atan2(rotatePoint[2], rotatePoint[1])
        const byang = Math.atan2(goalRotatePoint[2], goalRotatePoint[1])
        const yang = byang - myang
        rotate('x', 0, yang)
      }

      function rotate(axis, polyIndex = 0, rads = 0.1) {
        const R = window.R
        const polygon = R[polyIndex]
        const theta = tf.scalar(rads)
        const tc = theta.cos().arraySync()
        const ts = theta.sin().arraySync()
        // https://en.wikipedia.org/wiki/Rotation_matrix#Basic_rotations
        // https://robotics.stackexchange.com/questions/10702/rotation-matrix-sign-convention-confusion
        let rotateMatrix // Not the normal right-hand rule version
        if (axis === 'x') {
          rotateMatrix = tf.tensor([
            [1, 0, 0],
            [0, tc, -ts],
            [0, ts, tc],
          ])
        } else if (axis === 'y') {
          rotateMatrix = tf.tensor([
            [tc, 0, ts],
            [0, 1, 0],
            [-ts, 0, tc],
          ])
        } else if (axis === 'z') {
          rotateMatrix = tf.tensor([
            [tc, ts, 0],
            [-ts, tc, 0],
            [0, 0, 1],
          ])
        }

        polygon.polyPoints.map((alignPoint, alignPointIndex) => {
          const tensorAlign = tf.tensor(alignPoint).reshape([3, 1])
          const newAlignPoint = tf.matMul(rotateMatrix, tensorAlign)
          const movedPoint = newAlignPoint.arraySync()
          polygon.polyPoints[alignPointIndex] = movedPoint
        })

        R[polyIndex] = polygon
        drawMulti('rotateContainer', R)

        window.R = R
        return polygon
      }

      function loadPoses() {
        const sequences = BLAZEPOSE_CONNECTED_KEYPOINTS_PAIRS.map((pair) => ({
          indices: pair,
        }))

        const inputPose = {
          metadata: [],
          sequences,
          polyPoints: POSES.pose1,
        }

        const goalPose = {
          metadata: [],
          sequences,
          polyPoints: POSES.pose2,
        }

        const posePoints = {
          focalPoint: Number(document.getElementById('focalPoint').value),
          alignPoint: Number(document.getElementById('alignPoint').value),
          rotatePoint: Number(document.getElementById('rotatePoint').value),
        }

        drawMulti('inputContainer', [inputPose], posePoints)

        drawMulti('goalContainer', [goalPose], posePoints)

        window.P = [inputPose, goalPose]
      }

      function overlayPoses() {
        const P = window.P

        const posePoints = {
          focalPoint: Number(document.getElementById('focalPoint').value),
          alignPoint: Number(document.getElementById('alignPoint').value),
          rotatePoint: Number(document.getElementById('rotatePoint').value),
        }

        drawMulti('transformedContainer', P, posePoints)
      }

      function processPoses() {
        const P = window.P

        const posePoints = {
          focalPoint: Number(document.getElementById('focalPoint').value),
          alignPoint: Number(document.getElementById('alignPoint').value),
          rotatePoint: Number(document.getElementById('rotatePoint').value),
        }

        drawMulti('transformedContainer', P, posePoints)
      }

      // Make Buttons Work
      document
        .getElementById('similarTriangles')
        .addEventListener('click', createStandard)

      document
        .getElementById('randomTriangles')
        .addEventListener('click', createR)

      document
        .getElementById('exactPolies')
        .addEventListener('click', () => createT(8))

      document
        .getElementById('originGoalPoly')
        .addEventListener('click', () => originPoly(1))

      document
        .getElementById('originInputPoly')
        .addEventListener('click', () => originPoly(0))

      document
        .getElementById('alignInputPoly')
        .addEventListener('click', () => alignPoly(0))

      document
        .getElementById('alignGoalPoly')
        .addEventListener('click', () => alignPoly(1))

      document
        .getElementById('rotateToGoal')
        .addEventListener('click', rotateToGoal)

      document
        .getElementById('rotateX')
        .addEventListener('click', () => rotate('x'))

      document
        .getElementById('rotateY')
        .addEventListener('click', () => rotate('y'))

      document
        .getElementById('rotateZ')
        .addEventListener('click', () => rotate('z'))

      document.getElementById('spinEm').addEventListener('click', spinEm)
      document.getElementById('loadPoses').addEventListener('click', loadPoses)

      document
        .getElementById('runProcess')
        .addEventListener('click', processPoses)
    </script>
  </body>
</html>
