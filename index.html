<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles.css" />
    <!-- Require the peer dependencies of pose-detection. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>

    <!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>

    <!-- Load three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.106.2/build/three.min.js"></script>
    <!-- Load scatter-gl.js -->
    <script src="https://cdn.jsdelivr.net/npm/scatter-gl@0.0.1/lib/scatter-gl.min.js"></script>

    <!--
    <script src="https://cdn.jsdelivr.net/npm/three@0.125/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scatter-gl@0.0.11/lib/scatter-gl.min.js"></script>
    -->

    <script>
      // These points will be added to scale the plot, but will be painted white to hide
      const ANCHOR_POINTS = [
        [0, 0, 0],
        [0, 1, 0],
        [-1, 0, 0],
        [-1, -1, 0],
      ]
      function spinEm() {
        // window.inputContainer.resize()
        window.inputContainer && window.inputContainer.startOrbitAnimation()
        window.goalContainer && window.goalContainer.startOrbitAnimation()
        window.transformedContainer &&
          window.transformedContainer.startOrbitAnimation()
      }
      function selectColor(colorNum, colors) {
        if (colors < 1) colors = 1 // defaults to one color - avoid divide by zero
        if (colorNum >= colors) return 'white'
        return 'hsl(' + ((colorNum * (360 / colors)) % 360) + ',100%,50%)'
      }

      function create3DPolygon(points = 3) {
        // Create *points* number of points 3D space (X, Y, Z)
        const polyPoints = Array.from({ length: points }, () => [
          Math.random(),
          Math.random(),
          Math.random(),
        ])

        const metadata = []
        const sequences = []
        for (let i = 0; i < points; i++) {
          // Add point labels
          metadata.push({
            labelIndex: i,
            label: `X: ${Number(polyPoints[i][0]).toFixed(1)} Y: ${Number(
              polyPoints[i][1]
            ).toFixed(1)} Z: ${Number(polyPoints[i][2]).toFixed(1)}`,
          })

          // Draw a line
          sequences.push({ indices: [i, (i + 1) % points] })
        }
        return {
          metadata,
          sequences,
          polyPoints,
        }
      }

      function simpleTriangle() {
        const polyPoints = [
          [0, 0, 0],
          [0.5, 0.5, 0.5],
          [1, 0, 1],
        ]
        const metadata = [
          {
            labelIndex: 0,
            label: points[0],
          },
          {
            labelIndex: 1,
            label: points[1],
          },
          {
            labelIndex: 2,
            label: points[2],
          },
        ]
        const sequences = [
          {
            indices: [0, 1],
          },
          {
            indices: [1, 2],
          },
          {
            indices: [2, 0],
          },
        ]
        return {
          metadata,
          sequences,
          polyPoints,
        }
      }

      function drawPolygon(destination, polygon) {
        // Create scatter graph
        const containerElement = document.getElementById(destination)
        const scatterGL = new ScatterGL(containerElement)

        // Get polydata
        const { polyPoints, metadata, sequences } = polygon
        const dataset = new ScatterGL.Dataset(
          [...polyPoints, ...ANCHOR_POINTS],
          metadata
        )

        // Add data to scatter graph + lines
        scatterGL.render(dataset)
        scatterGL.setSequences(sequences)
        scatterGL.setPointColorer((index) =>
          selectColor(index, polyPoints.length)
        )
        scatterGL.scatterPlot.setPolylineOpacities(
          new Array(polyPoints.length).fill(1)
        )

        // store on Global for accessibility
        window[destination] = scatterGL
      }

      async function runCode() {
        const inputPolygon = create3DPolygon(3)
        drawPolygon('inputContainer', inputPolygon)
        const goalPolygon = create3DPolygon(4)
        drawPolygon('goalContainer', goalPolygon)
        const transformedPolygon = create3DPolygon(5)
        drawPolygon('transformedContainer', transformedPolygon)
      }
    </script>
  </head>
  <body>
    <h1>Normalization</h1>
    <div id="squeezer">
      <div class="poseGroup">
        <div class="grouping">
          <h2>Input</h2>
          <div id="inputContainer" class="chart"></div>
        </div>
        <div class="grouping">
          <h2>Goal</h2>
          <div id="goalContainer" class="chart"></div>
        </div>
        <div class="grouping">
          <h2>Transformed</h2>
          <div id="transformedContainer" class="chart"></div>
        </div>
      </div>
    </div>

    <div id="controls">
      <button onclick="runCode()">Process stuff</button>
      <button onclick="spinEm()">Spin Em</button>
    </div>
  </body>
</html>
